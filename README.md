# AntiZapret-Core

AntiZapret-Core — это инструмент для расширенного управления сетевой маршрутизацией и DNS на стороне сервера. Он позволяет автоматизировать процесс перенаправления трафика для определенных списков ресурсов и настраивать избирательное проксирование.

## Основные возможности

- **Избирательная маршрутизация:** Перенаправляет трафик только для выбранных ресурсов, не затрагивая остальную сетевую активность.
- **Гибкая настройка DNS:** Поддержка различных резолверов (Cloudflare, Quad9, SkyDNS и другие) с возможностью переопределения.
- **Сетевая фильтрация:** Опциональная очистка трафика от рекламы, трекеров и вредоносного ПО.
- **Поддержка сервисов:** Готовые пресеты для оптимизации доступа к популярным платформам (Discord, Telegram, Cloudflare, Google и др.).
- **Автоматизация обновлений:** Встроенные механизмы синхронизации списков по расписанию.

---

## Варианты установки

### 1. Нативная установка (Debian/Ubuntu)

Рекомендуется для выделенных серверов (VPS) на базе дистрибутивов Debian или Ubuntu.

**Требования:**
- ОС: Debian 11/12 или Ubuntu 22.04/24.04.
- Виртуализация: KVM, VMware или физический сервер (OpenVZ/LXC не поддерживаются).
- Минимум 2 ГБ свободного места.

**Команда для установки:**
```bash
bash <(wget -qO- --no-hsts --inet4-only https://raw.githubusercontent.com/UtyaDev/AntiZapret-Core/main/setup.sh)
```
Скрипт предложит выбрать DNS-резолверы и задать параметры конфигурации. После установки сервер перезагрузиться.

---

### 2. Установка через Docker (Готовый образ)

Универсальный способ запуска в изолированной среде.

**Подготовка:**
Создайте директорию и загрузите конфигурацию:
```bash
mkdir -p /opt/antizapret && cd /opt/antizapret
wget https://raw.githubusercontent.com/UtyaDev/AntiZapret-Core/main/docker-compose.yml
```

**Запуск:**
```bash
docker compose up -d
```

---

### 3. Установка через Docker (Сборка из исходников)

Для тех, кто хочет самостоятельно собрать образ или внести изменения в код.

**Инструкция:**
1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/UtyaDev/AntiZapret-Core.git
   cd AntiZapret-Core
   ```
2. Соберите и запустите проект:
   ```bash
   docker compose up -d --build
   ```

---

## Конфигурация

Параметры управления поведением системы (через переменные окружения в docker-compose.yml или в `/root/antizapret/setup` в случае нативаной установки):

| Переменная | Значение | Описание | Применимость |
|------------|----------|----------|--------------|
| `ANTIZAPRET_DNS` | `1-6` | Выбор апстрим DNS: 1 — Cloudflare+Quad9, 2 — SkyDNS, 3 — Cloudflare/Quad9, 4 — Comss, 5 — XBox, 6 — Malw. | Все |
| `BLOCK_ADS` | `y/n` | Блокировка рекламы, трекеров и фишинга на уровне DNS. | Все |
| `ALTERNATIVE_IP` | `y/n` | Использовать диапазон `172.x.x.x` вместо `10.x.x.x`. | Все |
| `ALTERNATIVE_FAKE_IP`| `y/n` | Использовать диапазон `198.18.0.0/15` для подменных адресов. | Все |
| `SSH_PROTECTION` | `y/n` | Защита от brute-force атак на SSH. | Нативная |
| `ATTACK_PROTECTION` | `y/n` | Защита от сетевых атак и сканирования. | Нативная |
| `CLEAR_HOSTS` | `y/n` | Очистка кэша при каждом запуске. | Docker |
| `DISCORD_INCLUDE` | `y/n` | Включить голосовые сервера Discord. | Все |
| `TELEGRAM_INCLUDE` | `y/n` | Включить сервера Telegram. | Все |
| `GOOGLE_INCLUDE` | `y/n` | Включить сервисы Google и YouTube. | Все |
| `CLOUDFLARE_INCLUDE`| `y/n` | Включить сети Cloudflare. | Все |
| `WHATSAPP_INCLUDE` | `y/n` | Включить сети WhatsApp. | Все |
| `ROBLOX_INCLUDE` | `y/n` | Включить сети Roblox. | Все |
| `AMAZON_INCLUDE` | `y/n` | Включить сети Amazon AWS. | Все |
| `HETZNER_INCLUDE` | `y/n` | Включить сети Hetzner. | Все |
| `DIGITALOCEAN_INCLUDE`| `y/n` | Включить сети DigitalOcean. | Все |
| `OVH_INCLUDE` | `y/n` | Включить сети OVH. | Все |
| `AKAMAI_INCLUDE` | `y/n` | Включить сети Akamai. | Все |

### Технические особенности Docker

Для работы сетевых функций контейнер требует расширенных прав доступа:

- `network_mode: host` — обязателен для управления сетевым стеком хоста.
- `privileged: true` — необходим для загрузки модулей ядра и изменения параметров `sysctl`.
- `cap_add: [NET_ADMIN, SYS_MODULE]` — права на администрирование сети.
- **Тома (Volumes):**
    - `./config` — пользовательские списки исключений.
    - `./result` — файлы с результатами генерации маршрутов.


## Управление списками ресурсов

Вы можете вручную определять правила маршрутизации в директории `config/`:

- `include-hosts.txt`: Ресурсы, трафик к которым всегда идет через прокси.
- `exclude-hosts.txt`: Ресурсы, трафик к которым всегда идет напрямую.
- `include-ips.txt`: Список IP-адресов для проксирования.
- `exclude-ips.txt`: Список IP-адресов для прямого доступа.

Для применения изменений в нативной версии выполните:
```bash
/root/antizapret/doall.sh
```

Для применения изменений в Docker-версии выполните:
```bash
docker exec antizapret /root/antizapret/doall.sh
```
---

## Благодарность

Проект базируется на наработках следующих авторов:
- [GubernievS/AntiZapret-VPN](https://github.com/GubernievS/AntiZapret-VPN) — за оригинальную реализацию и логику работы.
- [xtrime-ru/antizapret-vpn-docker](https://github.com/xtrime-ru/antizapret-vpn-docker) — за помощь с Docker-реализацией.
